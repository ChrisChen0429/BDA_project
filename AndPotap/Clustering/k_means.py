# ===========================================================================
# Notes
# ===========================================================================
"""
(*) This script performs k-means on the data to understand some of the
    structure in the data
"""
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Import packages
# ===========================================================================
import os
# import numpy as np
import pandas as pd
from AndPotap.Utils.cluster import k_means_addition
import multiprocessing
from functools import partial
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Determine files
# ===========================================================================
# Set working directory
os.chdir('/Users/andpotap/Documents/Columbia/BS/BDA_project')

# Select files for input and output
# Input
# file_input = './AndPotap/DBs/core_sample.txt'
file_input = './AndPotap/DBs/core.txt'

# Output
file_output = './AndPotap/DBs/core_clusters.txt'
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Load files
# ===========================================================================
df = pd.read_csv(filepath_or_buffer=file_input, sep='|')
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Select relevant columns
# ===========================================================================
selected_columns = [
    'age',
    'client_income',
    'risk_index',
    'ratio',
    'lender_score',
    'asset_market_value',
    'factor_employed',
    'effective_pay'
]
# x = df[selected_columns].values
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Perform clustering
# ===========================================================================
# k = 5
# df_aux = k_means_addition(k=k,
#                           df=df,
#                           selected_columns=selected_columns,
#                           seed=24524)
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Perform Multiprocess clustering
# ===========================================================================
pool = multiprocessing.Pool()
iterable = [3, 5, 7, 10, 12, 20]
f = partial(k_means_addition,
            df=df,
            selected_columns=selected_columns,
            seed=12342)

zz = pool.map(func=f, iterable=iterable)
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Merge back
# ===========================================================================
T = len(zz)
for j in range(T):
    df = pd.merge(left=df, right=zz[j][0], how='inner', on='mortgage_id')
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Write output
# ===========================================================================
df.to_csv(path_or_buf=file_output, sep='|', index=False)
# ===========================================================================
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ===========================================================================
# Results from 1 pass
# ===========================================================================
# Cluster default rates
#                  y
#                mean count
# cluster_7
# 0          0.057076  2558
# 1          0.054360  5298
# 2          0.056318  5611
# 3          0.116234  8784
# 4          0.000000    20
# 5          0.032468   154
# 6          0.021922  8074

# Cluster centers
# array([[39.12, 1270.19, 2219.00, 0.23, 143.53, 1301296.06, 4.28, 29.71],
#        [26.54, 317.07, 2172.06, 0.27, 122.91, 430205.33, 1.21, 31.92],
#        [47.92, 319.25, 2219.21, 0.27, 137.23, 437861.11, 1.26, 30.38],
#        [30.85, 312.95, 2207.38, 0.29, 134.61, 471678.88, 1.39, 19.86],
#        [30.70, 310.40, -0.00, 0.27, -0.00, 661889.07, 1.15, 25.05],
#        [38.58, 1154.44, 2224.16, 0.23, 142.60, 1127752.60, 102.69, 13.59],
#        [32.05, 352.27, 2208.85, 0.26, 137.82, 471304.10, 1.34, 36.27]])

# Columns
# selected_columns = [
#     'age', 'client_income', 'risk_index', 'ratio',
#     'lender_score', 'asset_market_value', 'factor_employed',
#     'effective_pay']
# ===========================================================================
